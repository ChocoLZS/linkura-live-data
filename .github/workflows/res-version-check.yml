name: Resource Version Check

permissions:
  contents: write

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      dry_run:
        description: 'Dry run mode (skip commit/upload/notification)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  check-res-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version-check.outputs.new_version }}
      update_type: ${{ steps.version-check.outputs.update_type }}
      client_version: ${{ steps.version-check.outputs.client_version }}
      res_version: ${{ steps.version-check.outputs.res_version }}
      old_client_version: ${{ steps.version-check.outputs.old_client_version }}
      old_res_version: ${{ steps.version-check.outputs.old_res_version }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
    
    - name: Run resource version check
      id: version-check
      run: |
        cd scripts
        chmod +x handle_res_version.sh
        
        # è·å–æ›´æ–°å‰çš„çŠ¶æ€
        OLD_RES_VERSION=""
        OLD_CLIENT_VERSION=""
        OLD_CLIENT_RES_HASH=""
        if [ -f "../data/res_version.txt" ]; then
          OLD_RES_VERSION=$(head -n 1 ../data/res_version.txt)
          echo "è„šæœ¬è¿è¡Œå‰ - OLD_RES_VERSION: [$OLD_RES_VERSION]"
        fi
        if [ -f "../others/linkura-googleplay-apk.csv" ]; then
          OLD_CLIENT_VERSION=$(head -2 ../others/linkura-googleplay-apk.csv | tail -1 | cut -d',' -f2)
          echo "è„šæœ¬è¿è¡Œå‰ - OLD_CLIENT_VERSION: [$OLD_CLIENT_VERSION]"
        fi
        if [ -f "../data/client-res.json" ]; then
          OLD_CLIENT_RES_HASH=$(sha256sum ../data/client-res.json | awk '{print $1}')
          echo "è„šæœ¬è¿è¡Œå‰ - OLD_CLIENT_RES_HASH: [$OLD_CLIENT_RES_HASH]"
        fi
        
        # è¿è¡Œç‰ˆæœ¬æ£€æŸ¥è„šæœ¬
        if ./handle_res_version.sh; then
          echo "new_version=true" >> $GITHUB_OUTPUT
          
          # è·å–æ›´æ–°åçš„ç‰ˆæœ¬ä¿¡æ¯
          NEW_RES_VERSION=$(head -n 1 ../data/res_version.txt)
          NEW_CLIENT_VERSION=$(head -2 ../others/linkura-googleplay-apk.csv | tail -1 | cut -d',' -f2)
          NEW_CLIENT_RES_HASH=""
          if [ -f "../data/client-res.json" ]; then
            NEW_CLIENT_RES_HASH=$(sha256sum ../data/client-res.json | awk '{print $1}')
            echo "è„šæœ¬è¿è¡Œå - NEW_CLIENT_RES_HASH: [$NEW_CLIENT_RES_HASH]"
          fi
          
          # ç¡®å®šæ›´æ–°ç±»å‹
          UPDATE_TYPE=""
          if [ "$OLD_CLIENT_VERSION" != "$NEW_CLIENT_VERSION" ] && [ "$OLD_RES_VERSION" != "$NEW_RES_VERSION" ]; then
            UPDATE_TYPE="client+res"
            echo "æ£€æµ‹åˆ°å®¢æˆ·ç«¯ç‰ˆæœ¬æ›´æ–°: $OLD_CLIENT_VERSION -> $NEW_CLIENT_VERSION"
            echo "æ£€æµ‹åˆ°èµ„æºç‰ˆæœ¬æ›´æ–°: $OLD_RES_VERSION -> $NEW_RES_VERSION"
          elif [ "$OLD_CLIENT_VERSION" != "$NEW_CLIENT_VERSION" ]; then
            UPDATE_TYPE="client"
            echo "æ£€æµ‹åˆ°å®¢æˆ·ç«¯ç‰ˆæœ¬æ›´æ–°: $OLD_CLIENT_VERSION -> $NEW_CLIENT_VERSION"
          elif [ "$OLD_RES_VERSION" != "$NEW_RES_VERSION" ]; then
            UPDATE_TYPE="res"
            echo "æ£€æµ‹åˆ°èµ„æºç‰ˆæœ¬æ›´æ–°: $OLD_RES_VERSION -> $NEW_RES_VERSION"
          elif [ "$OLD_CLIENT_RES_HASH" != "$NEW_CLIENT_RES_HASH" ]; then
            UPDATE_TYPE="client-res"
            echo "æ£€æµ‹åˆ° client-res.json ä¿®å¤æˆ–å˜æ›´"
          else
            UPDATE_TYPE="unknown"
          fi
          
          # è¾“å‡ºå˜é‡
          echo "update_type=$UPDATE_TYPE" >> $GITHUB_OUTPUT
          echo "client_version=$NEW_CLIENT_VERSION" >> $GITHUB_OUTPUT
          echo "res_version=$NEW_RES_VERSION" >> $GITHUB_OUTPUT
          echo "old_client_version=$OLD_CLIENT_VERSION" >> $GITHUB_OUTPUT
          echo "old_res_version=$OLD_RES_VERSION" >> $GITHUB_OUTPUT
          
        else
          echo "new_version=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°"
        fi
    
    - name: Configure Git
      if: steps.version-check.outputs.new_version == 'true' && github.event.inputs.dry_run != 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Get the current date time
      id: datetime
      if: steps.version-check.outputs.new_version == 'true'
      run: echo "time_now=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
    
    - name: Generate commit message
      if: steps.version-check.outputs.new_version == 'true'
      id: commit-msg
      run: |
        UPDATE_TYPE="${{ steps.version-check.outputs.update_type }}"
        CLIENT_VER="${{ steps.version-check.outputs.client_version }}"
        RES_VER="${{ steps.version-check.outputs.res_version }}"
        OLD_CLIENT_VER="${{ steps.version-check.outputs.old_client_version }}"
        OLD_RES_VER="${{ steps.version-check.outputs.old_res_version }}"
        DATETIME="${{ steps.datetime.outputs.time_now }}"
        
        case "$UPDATE_TYPE" in
          "client+res")
            MSG="feat: update client v${CLIENT_VER} + resource ${RES_VER} (${DATETIME})"
            ;;
          "client")
            MSG="feat: update client version ${OLD_CLIENT_VER} -> ${CLIENT_VER} (${DATETIME})"
            ;;
          "res")
            MSG="feat: update resource version ${OLD_RES_VER} -> ${RES_VER} (${DATETIME})"
            ;;
          "client-res")
            MSG="fix: repair client-res mapping (${DATETIME})"
            ;;
          *)
            MSG="feat: version update (${DATETIME})"
            ;;
        esac
        
        echo "commit_message=${MSG}" >> $GITHUB_OUTPUT
        echo "ç”Ÿæˆçš„æäº¤ä¿¡æ¯: ${MSG}"

    - name: Commit and push changes
      if: steps.version-check.outputs.new_version == 'true' && github.event.inputs.dry_run != 'true'
      uses: EndBug/add-and-commit@v9
      with:
        default_author: github_actions
        message: '${{ steps.commit-msg.outputs.commit_message }}'
        add: |
          - data/res_version.txt
          - others/linkura-googleplay-apk.csv
          - data/client-res.json

    - name: Dry run summary
      if: steps.version-check.outputs.new_version == 'true' && github.event.inputs.dry_run == 'true'
      run: |
        echo "ğŸ§ª **Dry Run æ¨¡å¼**" >> $GITHUB_STEP_SUMMARY
        echo "æœ¬æ¬¡ä¸ä¼šæäº¤ä»£ç ã€ä¸ä¼šä¸Šä¼  R2ã€ä¸ä¼šå‘é€çœŸå®é€šçŸ¥ã€‚" >> $GITHUB_STEP_SUMMARY
        echo "é¢„æœŸæäº¤ä¿¡æ¯: \`${{ steps.commit-msg.outputs.commit_message }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
    
    - name: Create summary
      run: |
        # è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
        CURRENT_CLIENT_VER=""
        CURRENT_RES_VER=""
        if [ -f "others/linkura-googleplay-apk.csv" ]; then
          CURRENT_CLIENT_VER=$(head -2 others/linkura-googleplay-apk.csv | tail -1 | cut -d',' -f2)
        fi
        if [ -f "data/res_version.txt" ]; then
          CURRENT_RES_VER=$(head -n 1 data/res_version.txt)
        fi
        
        # å§‹ç»ˆæ˜¾ç¤ºå½“å‰ç‰ˆæœ¬ä¿¡æ¯
        echo "ğŸ“Š **å½“å‰ç‰ˆæœ¬ä¿¡æ¯**" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ”„ å®¢æˆ·ç«¯ç‰ˆæœ¬: ${CURRENT_CLIENT_VER:-æœªçŸ¥}" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“¦ èµ„æºç‰ˆæœ¬: ${CURRENT_RES_VER:-æœªçŸ¥}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.version-check.outputs.new_version }}" == "true" ]; then
          UPDATE_TYPE="${{ steps.version-check.outputs.update_type }}"
          CLIENT_VER="${{ steps.version-check.outputs.client_version }}"
          RES_VER="${{ steps.version-check.outputs.res_version }}"
          OLD_CLIENT_VER="${{ steps.version-check.outputs.old_client_version }}"
          OLD_RES_VER="${{ steps.version-check.outputs.old_res_version }}"
          
          echo "ğŸ‰ **æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°**" >> $GITHUB_STEP_SUMMARY
          case "$UPDATE_TYPE" in
            "client+res")
              echo "ğŸ”„ å®¢æˆ·ç«¯: ${OLD_CLIENT_VER} â†’ ${CLIENT_VER}" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ“¦ èµ„æº: ${OLD_RES_VER} â†’ ${RES_VER}" >> $GITHUB_STEP_SUMMARY
              ;;
            "client")
              echo "ğŸ”„ å®¢æˆ·ç«¯: ${OLD_CLIENT_VER} â†’ ${CLIENT_VER}" >> $GITHUB_STEP_SUMMARY
              ;;
            "res")
              echo "ğŸ“¦ èµ„æº: ${OLD_RES_VER} â†’ ${RES_VER}" >> $GITHUB_STEP_SUMMARY
              ;;
            "client-res")
              echo "ğŸ› ï¸ client-res.json: æ˜ å°„å·²ä¿®å¤" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "âœ… æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "ğŸ§ª Dry Runï¼šæœªæäº¤ä»“åº“å˜æ›´ï¼ˆä»…é¢„è§ˆï¼‰" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸ“ å·²æäº¤æ›´æ–°åˆ°ä»“åº“" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â„¹ï¸ **æ²¡æœ‰æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°**" >> $GITHUB_STEP_SUMMARY
        fi

  auto-upload:
    runs-on: ubuntu-latest
    needs: check-res-version
    if: ${{ success() && needs.check-res-version.outputs.new_version == 'true' && github.event.inputs.dry_run != 'true' }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: 'main'
        fetch-depth: 2  # éœ€è¦è·å–å‰ä¸¤ä¸ªæäº¤æ¥æ¯”è¾ƒå·®å¼‚
    
    - name: Setup Python and dependencies
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install Python dependencies
      run: pip install requests
    
    - name: Upload client-res.json to R2
      env:
        R2_BUCKET: ${{ secrets.R2_BUCKET }}
        R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
        R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      run: |
        # ä½¿ç”¨linkura-motion-cliå·¥å…·ä¸Šä¼ client-res.json
        TOOL_URL="https://github.com/ChocoLZS/linkura-cli/releases/download/linkura-motion-cli-v1.1.0/linkura-motion-cli-x86_64-unknown-linux-musl.tar.gz"
        TOOL_NAME="linkura-motion-cli"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        TEMP_DIR=$(mktemp -d)
        
        echo "ä¸‹è½½ linkura-motion-cli..."
        curl -L "$TOOL_URL" -o "$TEMP_DIR/linkura-motion-cli.tar.gz"
        
        echo "è§£å‹ linkura-motion-cli..."
        tar -xzf "$TEMP_DIR/linkura-motion-cli.tar.gz" -C "$TEMP_DIR"
        chmod +x "$TEMP_DIR/$TOOL_NAME"
        
        echo "ä¸Šä¼  client-res.json åˆ° R2..."
        if [ -f "data/client-res.json" ]; then
          # ä½¿ç”¨linkura-motion-cliä¸Šä¼ æ–‡ä»¶
          # å‚æ•°è¯´æ˜: -p æŒ‡å®šé¡¹ç›®ç±»å‹ï¼Œ-f æŒ‡å®šæ–‡ä»¶è·¯å¾„ï¼Œ-c æŒ‡å®šå¹¶å‘æ•°
          "$TEMP_DIR/$TOOL_NAME" upload -p client-res -f "data/client-res.json" -c 1
          echo "âœ… client-res.json å·²æˆåŠŸä¸Šä¼ åˆ° R2"
        else
          echo "âŒ é”™è¯¯: data/client-res.json æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -rf "$TEMP_DIR"
        
        echo "ä¸Šä¼ ä»»åŠ¡å®Œæˆ"

  notification:
    runs-on: ubuntu-latest
    needs: check-res-version
    if: ${{ success() && needs.check-res-version.outputs.new_version == 'true' }}
    
    steps:
    - name: Send notification
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        QQ_BOT_URL: ${{ secrets.QQ_BOT_URL }}
        QQ_BOT_HOST: ${{ secrets.QQ_BOT_HOST }}
        GROUP_ID: ${{ secrets.GROUP_ID }}
        AUTH_TOKEN: ${{ secrets.AUTH_TOKEN }}
      run: |
        UPDATE_TYPE="${{ needs.check-res-version.outputs.update_type }}"
        CLIENT_VER="${{ needs.check-res-version.outputs.client_version }}"
        RES_VER="${{ needs.check-res-version.outputs.res_version }}"
        OLD_CLIENT_VER="${{ needs.check-res-version.outputs.old_client_version }}"
        OLD_RES_VER="${{ needs.check-res-version.outputs.old_res_version }}"
        
        # æ„å»ºå˜åŒ–æ˜¾ç¤ºæ–‡æœ¬
        OLD_CLIENT_DISPLAY="${OLD_CLIENT_VER:-æœªçŸ¥}"
        NEW_CLIENT_DISPLAY="${CLIENT_VER:-æœªçŸ¥}"
        OLD_RES_DISPLAY="${OLD_RES_VER:-æœªçŸ¥}"
        NEW_RES_DISPLAY="${RES_VER:-æœªçŸ¥}"

        CLIENT_CHANGE_LINE="ğŸ”„ å®¢æˆ·ç«¯: ${OLD_CLIENT_DISPLAY} â†’ ${NEW_CLIENT_DISPLAY}"
        RES_CHANGE_LINE="ğŸ“¦ èµ„æº: ${OLD_RES_DISPLAY} â†’ ${NEW_RES_DISPLAY}"
        CLIENT_RES_FIX_LINE="ğŸ› ï¸ client-res.json: æ˜ å°„å·²ä¿®å¤"

        # æ ¹æ®æ›´æ–°ç±»å‹æ„å»ºæ¶ˆæ¯ï¼šä»…å±•ç¤ºå®é™…å‘ç”Ÿå˜åŒ–çš„é¡¹
        case "$UPDATE_TYPE" in
          "client+res")
            TG_MSG="ğŸ‰ Linkura æ›´æ–°%0A%0A${CLIENT_CHANGE_LINE}%0A${RES_CHANGE_LINE}"
            QQ_MSG="ğŸ‰ Linkura æ›´æ–°\n\n${CLIENT_CHANGE_LINE}\n${RES_CHANGE_LINE}"
            ;;
          "client")
            TG_MSG="ğŸ‰ Linkura æ›´æ–°%0A%0A${CLIENT_CHANGE_LINE}"
            QQ_MSG="ğŸ‰ Linkura æ›´æ–°\n\n${CLIENT_CHANGE_LINE}"
            ;;
          "res")
            TG_MSG="ğŸ‰ Linkura æ›´æ–°%0A%0A${RES_CHANGE_LINE}"
            QQ_MSG="ğŸ‰ Linkura æ›´æ–°\n\n${RES_CHANGE_LINE}"
            ;;
          "client-res")
            TG_MSG="ğŸ‰ Linkura æ›´æ–°%0A%0A${CLIENT_RES_FIX_LINE}"
            QQ_MSG="ğŸ‰ Linkura æ›´æ–°\n\n${CLIENT_RES_FIX_LINE}"
            ;;
          *)
            TG_MSG="ğŸ‰ Linkura æ›´æ–°%0A%0Aâœ… æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°"
            QQ_MSG="ğŸ‰ Linkura æ›´æ–°\n\nâœ… æ£€æµ‹åˆ°ç‰ˆæœ¬æ›´æ–°"
            ;;
        esac

        if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
          TG_PREVIEW="${TG_MSG//%0A/$'\n'}"
          echo "ğŸ§ª Dry Run æ¨¡å¼ï¼šè·³è¿‡çœŸå®é€šçŸ¥å‘é€"
          echo "Telegram æ¶ˆæ¯é¢„è§ˆ:"
          printf "%b\n" "$TG_PREVIEW"
          echo ""
          echo "QQ æ¶ˆæ¯é¢„è§ˆ:"
          printf "%b\n" "$QQ_MSG"
          exit 0
        fi
        
        echo "å‘é€ Telegram é€šçŸ¥..."
        
        # å‘é€ Telegram æ¶ˆæ¯
        TG_HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d "chat_id=${TELEGRAM_CHAT_ID}" \
          -d "text=${TG_MSG}")
        
        if [ "$TG_HTTP_CODE" = "200" ]; then
          echo "âœ… Telegram é€šçŸ¥å‘é€æˆåŠŸ"
        else
          echo "âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥ (HTTP: $TG_HTTP_CODE)"
        fi
        
        echo ""
        echo "å‘é€ QQ é€šçŸ¥..."
        
        # å‘é€ QQ æ¶ˆæ¯
        if [ -n "$QQ_BOT_URL" ] && [ -n "$GROUP_ID" ] && [ -n "$AUTH_TOKEN" ] && [ -n "$QQ_BOT_HOST" ]; then
          QQ_HTTP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" -X POST "${QQ_BOT_URL}/send_group_msg" \
            -H "Authorization: Bearer ${AUTH_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "Host: ${QQ_BOT_HOST}" \
            -d "{\"group_id\":\"${GROUP_ID}\",\"message\":[{\"type\":\"text\",\"data\":{\"text\":\"${QQ_MSG}\"}}]}")
          
          if [ "$QQ_HTTP_CODE" = "200" ]; then
            echo "âœ… QQ é€šçŸ¥å‘é€æˆåŠŸ"
          else
            echo "âŒ QQ é€šçŸ¥å‘é€å¤±è´¥ (HTTP: $QQ_HTTP_CODE)"
          fi
        else
          echo "âš ï¸ QQ é€šçŸ¥é…ç½®ä¸å®Œæ•´ï¼Œè·³è¿‡ QQ é€šçŸ¥"
        fi
