name: Resource Version Check

permissions:
  contents: write

on:
  schedule:
    # 每30分钟运行一次
    - cron: '*/10 * * * *'
  workflow_dispatch:  # 允许手动触发

jobs:
  check-res-version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version-check.outputs.new_version }}
      version: ${{ steps.version-check.outputs.version }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y curl
    
    - name: Run resource version check
      id: version-check
      run: |
        cd scripts
        chmod +x handle_res_version.sh
        if ./handle_res_version.sh; then
          echo "new_version=true" >> $GITHUB_OUTPUT
          # 获取新版本号用于commit信息
          NEW_VERSION=$(head -n 1 ../data/res_version.txt)
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "检测到新的资源版本: $NEW_VERSION"
        else
          echo "new_version=false" >> $GITHUB_OUTPUT
          echo "没有检测到新的资源版本"
        fi
    
    - name: Configure Git
      if: steps.version-check.outputs.new_version == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Get the current date time
      id: datetime
      if: steps.version-check.outputs.new_version == 'true'
      run: echo "time_now=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
    
    - name: Commit and push changes
      if: steps.version-check.outputs.new_version == 'true'
      uses: EndBug/add-and-commit@v9
      with:
        default_author: github_actions
        message: 'res version(${{ steps.datetime.outputs.time_now }}): ${{ steps.version-check.outputs.version }}'
        add: |
          - data/res_version.txt
    
    - name: Create summary
      run: |
        if [ "${{ steps.version-check.outputs.new_version }}" == "true" ]; then
          echo "✅ 检测到新的资源版本: ${{ steps.version-check.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "📝 已提交更新到仓库" >> $GITHUB_STEP_SUMMARY
        else
          echo "ℹ️ 没有检测到新的资源版本" >> $GITHUB_STEP_SUMMARY
        fi

  notification:
    runs-on: ubuntu-latest
    needs: check-res-version
    if: always()  # 无论是否有新版本都发送通知
    
    steps:
    - name: Send Uptime notification
      run: |
        # 构建消息内容
        if [ "${{ needs.check-res-version.outputs.new_version }}" == "true" ]; then
          MSG="检测到新的资源版本: ${{ needs.check-res-version.outputs.version }}"
          STATUS="up"
        else
          MSG="资源版本检查完成，无新版本"
          STATUS="up"
        fi
        
        # URL编码消息
        ENCODED_MSG=$(echo "$MSG" | python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.stdin.read().strip()))")
        
        # 构建完整的URL
        UPTIME_URL="${{ secrets.UPTIME_URL_RES_CHECK }}?status=up&ping=&msg=${ENCODED_MSG}"
        
        echo "发送通知: $MSG"
        echo "编码后的消息: $ENCODED_MSG"
        
        # 发送请求，添加User-Agent和其他headers来绕过Cloudflare
        curl -L \
          -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36" \
          -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" \
          -H "Accept-Language: en-US,en;q=0.5" \
          -H "Accept-Encoding: gzip, deflate" \
          -H "Connection: keep-alive" \
          -H "Upgrade-Insecure-Requests: 1" \
          --max-time 30 \
          "$UPTIME_URL" || echo "Uptime通知发送失败"
